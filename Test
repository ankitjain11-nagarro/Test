SELECT c.id AS campaign_id, c.organization AS cam_organization, c.vertical AS cam_vertical, c.division AS cam_division, c.department AS cam_department, c.name AS campaign_name, c.code AS campaign_code, c.start_date, c.end_date, t.id AS template_id, t.name AS template_name, t.code AS template_code, t.category AS category, t.type AS template_type, t.organization AS temp_organization, t.vertical AS temp_vertical, t.division AS temp_division, t.department AS temp_department, wtc.id AS whatsapp_template_cta_id, wtc.label, wtc.url, wtc.sequence, wtc.type AS cta_type, wtc.sub_type, wtc.param, wtc.param_placeholder, wtc.call_back_number, wt.sequence AS template_sequence, wt.type AS whatsapp_type, wt.media_type, wt.media_url, wt.id AS whatsapp_template_id, wtc.button_action, wt.media_file_name, st.telemarketer_id, t.lang_code AS language, wtc.form_code AS cta_form_code, wt.media_channel, wt.media_meta_id, wt.footer_content, wt.meta_template_id, wt.media_extension, st.url_shorten, st.message_count, et.subject, eta.attachment_url, rt.id AS rcs_template_id,  rt.sequence AS rcs_template_sequence, rt.type AS rcs_type, rt.media_type AS rcs_media_type, rt.media_url AS rcs_media_url, rt.video_thumbnail AS rcs_video_thumbnail, rt.url_shorten AS rcs_url_shorten, rt.media_extension AS rcs_media_extension, rt.title AS rcs_title, rtc.id AS rcs_template_cta_id, rtc.label AS rcs_cta_label, rtc.url AS rcs_cta_url, rtc.sequence AS rcs_cta_sequence, rtc.sub_type AS rcs_cta_sub_type, rtc.param_placeholder AS rcs_cta_param_placeholder, rtc.call_back_number AS rcs_call_back_number, rtc.button_action AS rcs_cta_button_action, rtc.form_code AS rcs_cta_form_code, rtc.postback AS rcs_postback, CASE  WHEN LOWER(t.type) = 'sms' THEN st.content  WHEN LOWER(t.type) = 'whatsapp' THEN wt.content    WHEN LOWER(t.type) = 'email' THEN et.html_content  WHEN LOWER(t.type) = 'rcs' THEN rt.content  ELSE NULL END AS content, CASE  WHEN LOWER(t.type) = 'sms' THEN st.dlt_id  WHEN LOWER(t.type) = 'whatsapp' THEN wt.meta_template_name  WHEN LOWER(t.type) = 'rcs' THEN rt.google_template_name  ELSE NULL END AS external_id, CASE     WHEN LOWER(t.type) = 'sms' THEN st.principal_id     ELSE NULL END AS pid, CASE  WHEN LOWER(t.type) = 'sms' THEN st.sender_id  WHEN LOWER(t.type) = 'whatsapp' THEN wt.sender_id  WHEN LOWER(t.type) = 'email' THEN et.sender_id  WHEN LOWER(t.type) = 'rcs' THEN ra.number  ELSE NULL END AS sender_id, CASE  WHEN LOWER(t.type) = 'sms' THEN st.form_code  WHEN LOWER(t.type) = 'whatsapp' THEN wt.form_code  WHEN LOWER(t.type) = 'rcs' THEN rt.form_code  WHEN LOWER(t.type) = 'email' THEN et.form_code     ELSE NULL END AS form_code FROM campaigns c INNER JOIN campaign_template ct ON c.id = ct.campaign_id INNER JOIN templates t ON t.id = ct.template_id LEFT JOIN sms_template st ON t.id = st.template_id LEFT JOIN whatsapp_template wt ON t.id = wt.template_id LEFT JOIN whatsapp_template_cta wtc ON wt.id = wtc.whatsapp_template_id LEFT JOIN email_template et ON t.id = et.template_id LEFT JOIN email_template_attachments eta ON et.id = eta.email_template_id LEFT JOIN rcs_template rt ON t.id = rt.template_id LEFT JOIN  rcs_template_cta rtc ON rt.id = rtc.rcs_template_id LEFT JOIN  rcs_agent ra ON rt.rcs_agent_id = ra.id WHERE LOWER(c.status) = 'published' AND c.end_date >= $1 AND LOWER(t.status) = 'published' AND t.active = TRUE AND ($2 IS NULL OR c.name = $2)
